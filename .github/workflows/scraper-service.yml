name: Deploy Lambda

on:
  push:
    branches:
      - scraper-service

jobs:
  deploy:
    name: deploy
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: scraper-service
    steps:

    - uses: actions/checkout@v2
    

    - name: Deploy in EC2
      env:
          PRIVATE_KEY: ${{ secrets.AWS_PRIVATE_KEY  }}
          HOSTNAME : ${{ secrets.HOSTNAME  }}
          USER_NAME : ${{ secrets.USER_NAME  }}
            
      run: |
        echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
        ssh -i private_key ${USER_NAME}@${HOSTNAME} '
          
          #Now we have got the access of EC2 and we will start the deploy .

          cd /home/ubuntu/scraper-service &&
          git checkout master &&
          git fetch --all &&
          git reset --hard origin/master &&
          git pull origin master &&
          docker-compose -f docker-compose.yml up -d --build 
          '